#include <AccelStepper.h>
#include <Servo.h>

// -------------------------
// HARDWARE CONFIGURATION
// -------------------------
AccelStepper feederStepper(AccelStepper::DRIVER, 5, 6);  // Feeder
AccelStepper zAxisStepper(AccelStepper::DRIVER, 7, 8);    // Z-axis (not used here)
AccelStepper benderStepper(AccelStepper::DRIVER, 9, 10);  // Bender

Servo servo01;

const int limitSwitch = 11;

// ----------------------------------
// SETUP
// ----------------------------------
void setup() {
  Serial.begin(9600);
  pinMode(limitSwitch, INPUT_PULLUP);

  servo01.attach(2);
  servo01.write(40);  // Bending pin UP

  feederStepper.setMaxSpeed(2000);
  zAxisStepper.setMaxSpeed(2000);
  benderStepper.setMaxSpeed(2000);

  // -------------------------
  // HOMING SEQUENCE
  // -------------------------
  // Move until limit switch is hit
  while (digitalRead(limitSwitch) != LOW) {
    benderStepper.setSpeed(1200);    // toward switch
    benderStepper.runSpeed();
  }

  delay(50);

  // Once switch is hit → set position
  benderStepper.setCurrentPosition(0);

  // Move BACKWARD 1400 steps to mechanical zero
  while (benderStepper.currentPosition() > -1400) {
    benderStepper.setSpeed(-1200);   // move away from switch
    benderStepper.run();
  }

  // Now define this as ZERO
  benderStepper.setCurrentPosition(0);

  Serial.println("Homing complete. Beginning STAR mode.");
  delay(500);
}

// -------------------------
// MAIN LOOP
// -------------------------
void loop() {
  // Start star bending immediately
  star();
  while (1);  // stop after one star
}

// -------------------------
// STAR FUNCTION
// -------------------------
void star() {

  int count = 0;
  const int feedMM = 38;
  const int feedConst = 48;
  const int feedSteps = feedMM * feedConst;

  const int angleConst = 18; // your machine's angle-to-step constant

  servo01.write(40);   // bender pin UP
  delay(200);

  while (count < 5) {

    // ============================
    // 1. FEED WIRE
    // ============================
    while (feederStepper.currentPosition() != feedSteps) {
      feederStepper.setSpeed(1200);
      feederStepper.run();
    }
    feederStepper.setCurrentPosition(0);

    // ============================
    // 2. FIRST BEND (52°)
    // ============================
    servo01.write(40);  // pin UP
    delay(200);

    while (benderStepper.currentPosition() != -52 * angleConst) {
      benderStepper.setSpeed(-700);
      benderStepper.run();
    }
    benderStepper.setCurrentPosition(0);
    delay(120);

    // Return to straight
    while (benderStepper.currentPosition() != 52 * angleConst) {
      benderStepper.setSpeed(1200);
      benderStepper.run();
    }
    benderStepper.setCurrentPosition(0);
    delay(120);

    // ============================
    // 3. FEED AGAIN
    // ============================
    while (feederStepper.currentPosition() != feedSteps) {
      feederStepper.setSpeed(1200);
      feederStepper.run();
    }
    feederStepper.setCurrentPosition(0);
    delay(100);

    // ============================
    // 4. STAR POINT SECOND BEND
    // ============================
    servo01.write(130); // pin DOWN
    delay(200);

    // Pre-bend offset
    while (benderStepper.currentPosition() != -42 * angleConst) {
      benderStepper.setSpeed(-1200);
      benderStepper.run();
    }
    benderStepper.setCurrentPosition(0);
    delay(200);

    servo01.write(40); // pin UP
    delay(200);

    // Main sharp bend
    while (benderStepper.currentPosition() != 105 * angleConst) {
      benderStepper.setSpeed(700);
      benderStepper.run();
    }
    benderStepper.setCurrentPosition(0);
    delay(80);

    // Return from sharp bend
    while (benderStepper.currentPosition() != -63 * angleConst) {
      benderStepper.setSpeed(-1200);
      benderStepper.run();
    }
    benderStepper.setCurrentPosition(0);
    delay(150);

    servo01.write(130);  // bender down for stability

    count++;
  }

  // End of star shape
  servo01.write(40);  // pin up
  feederStepper.setCurrentPosition(0);
  benderStepper.setCurrentPosition(0);
  Serial.println("Star complete!");
}
