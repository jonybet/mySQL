#include <AccelStepper.h>
#include <Servo.h>

// ------------ PIN DEFINITIONS ------------
#define BENDER_STEP 9
#define BENDER_DIR 10
#define LIMIT_SWITCH 11
#define SERVO_PIN 2

#define FEED_STEP 5
#define FEED_DIR 6

#define Z_STEP 7
#define Z_DIR 8

// ------------ OBJECTS ------------
AccelStepper bender(AccelStepper::DRIVER, BENDER_STEP, BENDER_DIR);
AccelStepper feeder(AccelStepper::DRIVER, FEED_STEP, FEED_DIR);
AccelStepper twister(AccelStepper::DRIVER, Z_STEP, Z_DIR);

Servo bendServo;

// ------------ CONSTANTS ------------
const int angleConst = 18;    // NEMA17 1.8° w/ DRV8825 1/32 microstep
const int feedLength = 1000;  // steps per star segment

// -----------------------------------------------------
// SAFETY: Check limit switch DURING motion
// -----------------------------------------------------
void checkLimitDuringMove() {
  if (digitalRead(LIMIT_SWITCH) == LOW) { // switch hit
    Serial.println("Limit hit during motion — Re-Homing...");
    bender.stop();
    delay(100);
    // Re-home
    while (digitalRead(LIMIT_SWITCH) == LOW) {
      bender.setSpeed(-600);  // move off the switch
      bender.runSpeed();
    }
    delay(100);
    // Move slowly back to switch to set true zero
    while (digitalRead(LIMIT_SWITCH) == HIGH) {
      bender.setSpeed(400);
      bender.runSpeed();
    }
    bender.setCurrentPosition(0);
    Serial.println("Re-homed. Position reset to 0.");
  }
}

// -----------------------------------------------------
// INITIAL HOMING FUNCTION
// -----------------------------------------------------
void homeBender() {
  Serial.println("Initial Homing...");

  // Move until switch is hit
  while (digitalRead(LIMIT_SWITCH) == HIGH) {
    bender.setSpeed(800);
    bender.runSpeed();
  }

  // Move off the switch slightly
  for (int i = 0; i < 300; i++) {
    bender.setSpeed(-400);
    bender.runSpeed();
  }

  // Approach slowly to get precise zero
  while (digitalRead(LIMIT_SWITCH) == HIGH) {
    bender.setSpeed(300);
    bender.runSpeed();
  }

  bender.setCurrentPosition(0);
  Serial.println("Homed. Bender = 0°");
  delay(200);
}

// -----------------------------------------------------
// MOVE BENDER TO ANGLE WITH SAFETY CHECKING
// -----------------------------------------------------
void bendTo(int angleDegrees) {
  long target = angleDegrees * angleConst;
  bender.moveTo(target);

  while (bender.distanceToGo() != 0) {
    bender.run();
    checkLimitDuringMove();  // <-- SAFETY CALL
  }
}

// -----------------------------------------------------
// FEED FORWARD
// -----------------------------------------------------
void feedWire(long steps) {
  feeder.moveTo(feeder.currentPosition() + steps);
  while (feeder.distanceToGo() != 0) {
    feeder.run();
  }
}

// -----------------------------------------------------
// TWIST WIRE (OPTIONAL)
// -----------------------------------------------------
void rotateZ(long steps) {
  twister.moveTo(twister.currentPosition() + steps);
  while (twister.distanceToGo() != 0) {
    twister.run();
  }
}

// -----------------------------------------------------
// 5-POINT STAR SEQUENCE
// -----------------------------------------------------
void makeStar() {
  Serial.println("Starting star sequence...");

  for (int i = 0; i < 5; i++) {
    Serial.print("Bend #");
    Serial.println(i + 1);

    // 1. Feed wire forward
    feedWire(feedLength);

    // 2. Lower servo
    bendServo.write(130);
    delay(300);

    // 3. Bend 144°
    bendTo(144);

    // 4. Lift servo
    bendServo.write(40);
    delay(200);

    // 5. Return to 0°
    bendTo(0);

    // 6. Optional Z-twist
    rotateZ(200); // small twist to keep shape stable
  }

  Serial.println("Star completed!");
}

// -----------------------------------------------------
// SETUP
// -----------------------------------------------------
void setup() {
  Serial.begin(115200);

  pinMode(LIMIT_SWITCH, INPUT_PULLUP);

  bendServo.attach(SERVO_PIN);
  bendServo.write(40); // start up

  bender.setMaxSpeed(2000);
  bender.setAcceleration(1500);

  feeder.setMaxSpeed(1500);
  feeder.setAcceleration(1200);

  twister.setMaxSpeed(1500);
  twister.setAcceleration(1200);

  delay(500);

  // HOME FIRST BEFORE ANY MOTION
  homeBender();
}

// -----------------------------------------------------
// LOOP
// -----------------------------------------------------
void loop() {
  makeStar();
  delay(3000); // pause then repeat
}
